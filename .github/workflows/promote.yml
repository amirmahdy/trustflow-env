name: promote

on:
  workflow_dispatch:
    inputs:
      from_env:
        description: "Source environment (dev|stage)"
        required: true
        type: choice
        options: [dev, stage]
      to_env:
        description: "Target environment (stage|prod) for manual update"
        required: false
        type: choice
        options: [stage, prod]

permissions:
  contents: read

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Emit digest for manual promotion
        run: |
          set -euo pipefail
          from_file="environments/${{ inputs.from_env }}/image-patch.yaml"
          if [[ ! -f "$from_file" ]]; then
            echo "Missing: $from_file" >&2
            exit 2
          fi

          from_image="$(sed -nE 's/^\s*image:\s*([^ ]+)\s*$/\1/p' "$from_file" | head -n1)"
          if [[ -z "$from_image" ]]; then
            echo "No image found in: $from_file" >&2
            exit 2
          fi

          if ! [[ "$from_image" =~ @sha256:[a-f0-9]{64}$ ]]; then
            echo "Source image is not digest-pinned: $from_image" >&2
            exit 2
          fi

          echo "IMAGE_REF=$from_image"
          if [[ -n "${{ inputs.to_env }}" ]]; then
            echo "Next: update environments/${{ inputs.to_env }}/image-patch.yaml and open a PR."
          else
            echo "Next: update the target environment image-patch.yaml and open a PR."
          fi
