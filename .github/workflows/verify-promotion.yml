name: verify-promotion

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      COSIGN_OIDC_ISSUER: https://token.actions.githubusercontent.com
      # Cosign's GitHub OIDC certificate identity format may vary by setup/version.
      # This regexp accepts the two most common forms while still pinning to this repo + workflow + branch.
      COSIGN_CERT_IDENTITY_REGEXP: (^https://github.com/${{ github.repository_owner }}/trustflow-app/.github/workflows/supply-chain.yml@refs/heads/main$)|(^repo:${{ github.repository_owner }}/trustflow-app:ref:refs/heads/main$)
    steps:
      - uses: actions/checkout@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.8.1
        with:
          cosign-release: v2.2.4

      - name: Verify signed + SBOM-attested images (digest-pinned)
        run: bash hack/verify-images.sh environments

      - name: Trivy scan promoted digests (env thresholds)
        env:
          TRIVY_IMAGE: aquasec/trivy:latest
          TRIVY_THRESHOLD_DEFAULT: HIGH
        run: |
          set -euo pipefail

          for env_dir in environments/*; do
            env_name="$(basename "$env_dir")"
            threshold_var="TRIVY_THRESHOLD_${env_name^^}"
            threshold="${!threshold_var:-${TRIVY_THRESHOLD_DEFAULT}}"
            threshold="${threshold^^}"

            case "$threshold" in
              CRITICAL) severities="CRITICAL" ;;
              HIGH) severities="HIGH,CRITICAL" ;;
              MEDIUM) severities="MEDIUM,HIGH,CRITICAL" ;;
              LOW) severities="LOW,MEDIUM,HIGH,CRITICAL" ;;
              UNKNOWN) severities="UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL" ;;
              *)
                echo "Unsupported Trivy threshold: ${threshold} (env: ${env_name})" >&2
                exit 2
                ;;
            esac

            mapfile -t images < <(bash hack/extract-images.sh "$env_dir")
            if [[ ${#images[@]} -eq 0 ]]; then
              echo "No pinned images found under: ${env_dir} (skipping)"
              continue
            fi

            for image in "${images[@]}"; do
              echo "Trivy scan (${env_name}, threshold ${threshold}): ${image}"
              docker run --rm \
                -v /var/run/docker.sock:/var/run/docker.sock \
                "${TRIVY_IMAGE}" \
                image \
                --severity "${severities}" \
                --exit-code 1 \
                --ignore-unfixed \
                --format table \
                "${image}"
            done
          done
